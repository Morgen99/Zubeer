<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --text-color: #333;
            --bg-color: #f5f8fa;
            --sidebar-bg: #2c3e50;
            --header-bg: #1a252f;
            --input-bg: #34495e;
            --message-sent: #3498db;
            --message-received: #ffffff;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --border-color: #e6e6e6;
        }
        
        .dark-mode {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --text-color: #ecf0f1;
            --bg-color: #1a1a1a;
            --sidebar-bg: #121212;
            --header-bg: #000000;
            --input-bg: #2d2d2d;
            --message-sent: #3498db;
            --message-received: #2d2d2d;
            --shadow: 0 2px 4px rgba(0,0,0,0.3);
            --border-color: #333;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            display: flex;
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            box-shadow: var(--shadow);
            background-color: var(--bg-color);
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 30%;
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            background-color: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .user-profile img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle, .menu-toggle {
            background: none;
            border: none;
            color: #bdc3c7;
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s;
        }
        
        .theme-toggle:hover, .menu-toggle:hover {
            color: white;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: #bdc3c7;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .logout-btn:hover {
            color: white;
        }
        
        .search-container {
            padding: 15px;
            background-color: var(--header-bg);
        }
        
        .search-container input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s;
        }
        
        .search-container input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .chat-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-list-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .chat-list-item.active {
            background-color: var(--primary-color);
        }
        
        .chat-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .chat-info {
            flex: 1;
            overflow: hidden;
        }
        
        .chat-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-info p {
            font-size: 14px;
            color: #bdc3c7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .time {
            font-size: 12px;
            color: #bdc3c7;
        }
        
        /* Chat Area Styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            transition: background-color 0.3s;
        }
        
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .chat-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }
        
        .chat-user-info {
            flex: 1;
        }
        
        .chat-header-controls {
            display: flex;
            gap: 15px;
        }
        
        .chat-header-controls button {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s;
        }
        
        .chat-header-controls button:hover {
            color: var(--primary-color);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            transition: background-color 0.3s;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .received {
            background-color: var(--message-received);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: var(--shadow);
            color: var(--text-color);
        }
        
        .sent {
            background-color: var(--message-sent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: var(--shadow);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-header img {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 12px;
        }
        
        .time-stamp {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 5px;
            text-align: right;
        }
        
        .message-input {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .message-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        .message-input input:focus {
            border-color: var(--primary-color);
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .send-button:hover {
            background-color: var(--secondary-color);
        }
        
        .send-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .no-chat-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
        }
        
        .no-chat-selected i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        
        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        
        .loading-dot {
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 5px;
            animation: bounce 1.5s infinite;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Menu Modal */
        .menu-modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100%;
            background-color: var(--sidebar-bg);
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .menu-modal.open {
            transform: translateX(0);
        }
        
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
        }
        
        .menu-section {
            margin-bottom: 25px;
        }
        
        .menu-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .menu-option {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            transition: color 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-option:last-child {
            border-bottom: none;
        }
        
        .menu-option i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .menu-option:hover {
            color: var(--primary-color);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-area {
                width: 100%;
                height: 60%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .menu-modal {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <img id="current-user-img" src="" alt="Profile">
                    <div>
                        <h3 id="current-user-name"></h3>
                        <p id="current-user-status">Online</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" id="theme-toggle" title="Bedel habka">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="menu-toggle" id="menu-toggle" title="Menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="logout-btn" id="logout-btn">Ka bax</button>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Raadi isticmaalayaal...">
            </div>
            
            <div class="loading" id="users-loading">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
            
            <ul class="chat-list" id="chat-list">
                <!-- Users will be loaded here -->
            </ul>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area" id="chat-area">
            <div class="no-chat-selected" id="no-chat">
                <i class="fas fa-comments"></i>
                <h3>Xulo qof aad wada sheekaysanaysid</h3>
                <p>Boggani waa uu ku tusayaa majaajilladaaga wada sheekaysiga</p>
            </div>
            
            <div class="chat-header" id="chat-header" style="display: none;">
                <img id="chat-user-img" src="" alt="User">
                <div class="chat-user-info">
                    <h3 id="chat-user-name"></h3>
                    <p id="chat-user-status">Online</p>
                </div>
                <div class="chat-header-controls">
                    <button id="view-profile-btn" title="Eeg profile-ka">
                        <i class="fas fa-user"></i>
                    </button>
                    <button id="call-btn" title="Wac">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button id="video-call-btn" title="Muqaal wac">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages" style="display: none;">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="message-input" id="message-input" style="display: none;">
                <input type="text" id="message-text" placeholder="Qor fariin...">
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Modal -->
    <div class="menu-modal" id="menu-modal">
        <div class="menu-header">
            <h2>Goobaha</h2>
            <button class="menu-close" id="menu-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="menu-section">
            <h3>Habituka</h3>
            <div class="menu-option" id="dark-mode-option">
                <i class="fas fa-moon"></i>
                <span>Dark Mode</span>
            </div>
            <div class="menu-option" id="light-mode-option">
                <i class="fas fa-sun"></i>
                <span>Light Mode</span>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Maareynta</h3>
            <div class="menu-option">
                <i class="fas fa-user-cog"></i>
                <span>Profile-kaaga</span>
            </div>
            <div class="menu-option">
                <i class="fas fa-bell"></i>
                <span>Ogeysiino</span>
            </div>
            <div class="menu-option">
                <i class="fas fa-lock"></i>
                <span>Sirta</span>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Kaa Caawiya</h3>
            <div class="menu-option">
                <i class="fas fa-question-circle"></i>
                <span>Taageero</span>
            </div>
            <div class="menu-option">
                <i class="fas fa-info-circle"></i>
                <span>Nagu saabsan</span>
            </div>
        </div>
    </div>

    <!-- Socket.io CDN -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let socket = null;
        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        
        // DOM elements
        const chatList = document.getElementById('chat-list');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const messageText = document.getElementById('message-text');
        const sendButton = document.getElementById('send-button');
        const noChat = document.getElementById('no-chat');
        const chatHeader = document.getElementById('chat-header');
        const usersLoading = document.getElementById('users-loading');
        const searchInput = document.getElementById('search-input');
        const themeToggle = document.getElementById('theme-toggle');
        const menuToggle = document.getElementById('menu-toggle');
        const menuModal = document.getElementById('menu-modal');
        const menuClose = document.getElementById('menu-close');
        const darkModeOption = document.getElementById('dark-mode-option');
        const lightModeOption = document.getElementById('light-mode-option');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            checkAuth();
            setupEventListeners();
        });
        
        // Initialize theme based on localStorage
        function initializeTheme() {
            if (darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // Toggle dark/light mode
        function toggleTheme() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // Check if user is authenticated
        async function checkAuth() {
            try {
                const response = await fetch('/check-auth');
                const data = await response.json();
                
                if (data.loggedIn) {
                    currentUser = {
                        id: data.userId,
                        username: data.username
                    };
                    
                    // Load user info and initialize socket
                    await loadUserInfo();
                    initSocket();
                    loadChatList();
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showError('Khalad ayaa dhacay markii la hubinayay akoonkaaga');
            }
        }
        
        // Load current user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                const userInfo = await response.json();
                
                document.getElementById('current-user-name').textContent = userInfo.username;
                document.getElementById('current-user-img').src = `/uploads/profiles/${userInfo.profileImage || 'default.png'}`;
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }
        
        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            // Handle connection events
            socket.on('connect', () => {
                console.log('Connected to server with ID:', socket.id);
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });
            
            // Handle incoming messages
            socket.on('receive-message', (data) => {
                if (data.chatId === currentChatId) {
                    addMessageToChat(data);
                }
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            messageText.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Search users
            searchInput.addEventListener('input', filterUsers);
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Menu toggle
            menuToggle.addEventListener('click', () => {
                menuModal.style.display = 'block';
                setTimeout(() => {
                    menuModal.classList.add('open');
                }, 10);
            });
            
            // Menu close
            menuClose.addEventListener('click', closeMenu);
            
            // Theme options
            darkModeOption.addEventListener('click', () => {
                if (!darkMode) toggleTheme();
                closeMenu();
            });
            
            lightModeOption.addEventListener('click', () => {
                if (darkMode) toggleTheme();
                closeMenu();
            });
            
            // View profile button
            viewProfileBtn.addEventListener('click', viewUserProfile);
            
            // Close menu when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === menuModal) {
                    closeMenu();
                }
            });
        }
        
        // Close menu modal
        function closeMenu() {
            menuModal.classList.remove('open');
            setTimeout(() => {
                menuModal.style.display = 'none';
            }, 300);
        }
        
        // View user profile
        function viewUserProfile() {
            if (currentChatUser) {
                window.open(`/profile.html?user=${currentChatUser.username}`, '_blank');
            }
        }
        
        // Load chat list (other users)
        async function loadChatList() {
            try {
                usersLoading.style.display = 'flex';
                chatList.innerHTML = '';
                
                const response = await fetch('/api/users');
                const users = await response.json();
                
                // Filter out current user
                const otherUsers = users.filter(user => user.id !== currentUser.id);
                
                if (otherUsers.length === 0) {
                    chatList.innerHTML = '<li class="no-users">Ma jiro isticmaale kale oo diiwaan gashan</li>';
                    return;
                }
                
                // Display users in chat list
                otherUsers.forEach(user => {
                    const listItem = document.createElement('li');
                    listItem.className = 'chat-list-item';
                    listItem.dataset.userId = user.id;
                    
                    listItem.innerHTML = `
                        <img src="/uploads/profiles/${user.profileImage || 'default.png'}" alt="${user.username}">
                        <div class="chat-info">
                            <h3>${user.username}</h3>
                            <p>Guji si aad u bilowdo wada sheekaysi</p>
                        </div>
                        <div class="time"></div>
                    `;
                    
                    listItem.addEventListener('click', () => openChat(user));
                    chatList.appendChild(listItem);
                });
                
                usersLoading.style.display = 'none';
            } catch (error) {
                console.error('Error loading chat list:', error);
                usersLoading.style.display = 'none';
                chatList.innerHTML = '<li class="error">Khalad ayaa dhacay markii la soo dejiyay liiska isticmaalayaasha</li>';
            }
        }
        
        // Filter users based on search input
        function filterUsers() {
            const searchTerm = searchInput.value.toLowerCase();
            const userItems = chatList.getElementsByClassName('chat-list-item');
            
            Array.from(userItems).forEach(item => {
                const userName = item.querySelector('h3').textContent.toLowerCase();
                if (userName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Open chat with a user
        async function openChat(user) {
            currentChatUser = user;
            currentChatId = [currentUser.id, user.id].sort().join('-');
            
            // Update UI
            document.querySelectorAll('.chat-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelector(`.chat-list-item[data-user-id="${user.id}"]`).classList.add('active');
            
            // Show chat area
            noChat.style.display = 'none';
            chatHeader.style.display = 'flex';
            chatMessages.style.display = 'flex';
            messageInput.style.display = 'flex';
            
            // Update chat header
            document.getElementById('chat-user-name').textContent = user.username;
            document.getElementById('chat-user-img').src = `/uploads/profiles/${user.profileImage || 'default.png'}`;
            
            // Join chat room
            socket.emit('join-chat', currentChatId);
            
            // Load chat messages
            await loadChatMessages();
        }
        
        // Load chat messages
        async function loadChatMessages() {
            try {
                chatMessages.innerHTML = '<div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
                
                const response = await fetch(`/api/chat/${currentChatId}`);
                const messages = await response.json();
                
                // Display messages
                chatMessages.innerHTML = '';
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div class="no-messages">Ma jiro majaajillo hore<br>Bilow wada sheekaysiga!</div>';
                    return;
                }
                
                messages.forEach(message => {
                    addMessageToChat(message);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading chat messages:', error);
                chatMessages.innerHTML = '<div class="error">Khalad ayaa dhacay markii la soo dejiyay majaajillada</div>';
            }
        }
        
        // Add message to chat
        function addMessageToChat(message) {
            const messageElement = createMessageElement(message);
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Create message element
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            const isSent = message.senderId === currentUser.id;
            
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            // Format timestamp
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageContent = `
                <p>${message.message}</p>
                <div class="time-stamp">${timeString}</div>
            `;
            
            // Add sender info for received messages
            if (!isSent && currentChatUser) {
                messageContent = `
                    <div class="message-header">
                        <img src="/uploads/profiles/${currentChatUser.profileImage || 'default.png'}" alt="${currentChatUser.username}">
                        <span class="message-sender">${currentChatUser.username}</span>
                    </div>
                    ${messageContent}
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            return messageDiv;
        }
        
        // Send message
        async function sendMessage() {
            const message = messageText.value.trim();
            
            if (!message || !currentChatId) return;
            
            try {
                // Disable send button during request
                sendButton.disabled = true;
                
                // Create message object
                const messageData = {
                    chatId: currentChatId,
                    senderId: currentUser.id,
                    senderUsername: currentUser.username,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                // Send message via socket
                socket.emit('send-message', messageData);
                
                // Also save to server via HTTP
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        message: messageData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                
                // Clear input
                messageText.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Khalad ayaa dhacay dirista fariinta');
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // Logout user
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showError('Khalad ayaa dhacay markii aad ka baxaysey');
            }
        }
        
        // Show error message
        function showError(message) {
            // You can implement a toast notification system here
            alert(message);
        }
    </script>
</body>
</html>